# Maintainers

## Cutting a new release

> [!CAUTION]
> Cutting a release, end-to-end, takes a reasonable amount of time --
> mostly waiting on the CI -- and also requires the availability of
> colleagues to properly review and approve.
>
> **Plan for it to take an entire working day.**
>
> Do not rush the process and avoid days on which you and colleagues
> have limited availability. Don't release on the last working day
> before a weekend or holiday, etc. If something goes awry before the
> point of no return, keep calm and _don't_ carry on: Better to revert
> and try again the next day than having a broken release (and a
> stressful evening)!

> [!NOTE]
> The following instructions are for cutting a full Topiary release,
> with all its subcomponents in lock-step. The `topiary-config` and
> `topiary-queries` subpackages can be updated and released with a
> higher cadence: see [below](#releasing-new-configuration-and-queries)
> for details.

### 1. Create a release preparation branch from `main`

- If necessary, cherry-pick the commits that should be included in the
  release. (This should only be done in exceptional circumstances.)

- Update the [`CHANGELOG`], if necessary. This is used in the release
  announcement, so ensure it conforms to the correct format (as
  described in the `CHANGELOG` introduction).

  - By convention, this should be up-to-date as part of the PR process,
    but it ought to be double-checked. (See [below][changelog-refresh]
    for suggestions on how to partially automate this.)

  - Retitle the "Unreleased" section to this release and create a fresh
    "Unreleased" section (see comments in the [`CHANGELOG`] for
    details).

    Don't forget to update the "Full list of changes" links
    appropriately.

> [!TIP]
> Do not wrap bullet points over multiple lines in the `CHANGELOG`.
> GitHub will preserve those line breaks in the Release Notes, which is
> probably not what you want.

> [!IMPORTANT]
> Point releases (i.e., not patch releases) should also be given a name,
> taking the form "[ADJECTIVE] [TREE]", incrementing alphabetically from
> the previous release (e.g., "Archetypal Aspen", "Benevolent Beech",
> etc.). Both parts are relatively loose, particularly when it comes to
> botanical correctness, and a degree of assonance has become
> traditional.
>
> The name should be decided amongst the team before release.

- Update the root level `Cargo.toml`.
  - Bump `workspace.package.version`.
  - Bump any workspace dependency versions, respectively.

> [!IMPORTANT]
> See [below](#releasing-new-configuration-and-queries) for details on
> how to do interim releases of `topiary-config` or `topiary-queries`.
> These subpackages are now versioned independently from Topiary (core,
> etc.), so their versions will diverge.

- Update lockfiles and the release workflow. Lockfiles should be kept up
  to date by the Renovate bot, but it's worth doing manually when
  preparing a release; the release workflow always needs manual
  updating.

  - Run `nix flake update` to update `flake.lock`.

  - Run `cargo update` to update `Cargo.lock`.

  - The release workflow is generated by [`dist`] (formerly
    `cargo-dist`); the version that is currently in use can be found
    in `dist-workspace.toml`. If a newer version exists, then:

    - Download the new version of `dist`.
    - Run `dist init`. This should update the `dist-workspace.toml`
      configuration and the release workflow (`.github/workflows/release.yml`)

- Push these changes and wait for green CI across all workflows and peer
  approval. Upon both, squash-and-merge the PR into `main`.

### 2. Make the release

- Tag the merged commit in `main` with the release version, prefixed
  with a `v` (e.g., `v0.1.0`), and push it to GitHub. The version number
  must match the one in `Cargo.toml`, otherwise `dist` will fail during
  CI.

  ```bash
  git tag v0.1.0
  git push --tags
  ```

> [!CAUTION]
> Pushing the tag will trigger the release workflow (described below).
> If that succeeds, the release is finalised. **This is the point of no
> return.** Only push the tag if you are sure everything is ready for
> the release.

- Let the `dist` release workflow create a new [release]. That is:

  - Build binary artefacts for a variety of targets (currently: Apple
    Silicon macOS, Intel macOS, x64 Windows, ARM64 Linux and x64 Linux).
    This can take some time; the best part of an hour.

  - Publish a release announcement, featuring the relevant section from
    the `CHANGELOG` for this version.

> [!WARNING]
> If this step fails, delete the new release tag as quickly as possible
> from GitHub and start over:
>
> ```bash
> git push --delete origin vX.Y.Z
> ```

- Update `crates.io`:

  ```bash
  cargo publish --workspace
  ```

> [!IMPORTANT]
> Publication to `crates.io` requires appropriate access. You may need
> to escalate this appropriately.

> [!TIP]
> `cargo tree --invert` is useful to determine the topology.

### 3. Publicise

> [!WARNING]
> Point releases, only. Don't publicise patch releases, unless there's a
> pressing need to do so (e.g., fix of a security vulnerability, etc.).

- Announce the new version on Tweag's Twitter, Discord and other
  official social network accounts, via someone with access.

- Share amongst other social networks (e.g., Reddit, Hacker News,
  Mastodon, etc.), under personal accounts, at your discretion.

## Releasing new configuration and queries

The `topiary-config` and `topiary-queries` packages may be released
outside of full releases, to be reactive to changes to supported
grammars and formatting queries, respectively. The process is not
dissimilar from a usual release:

1. Create a preparation branch from `main`. Unlike a full release,
   there's no need to freeze the [`CHANGELOG`]. However, the versions of
   `topiary-config` and/or `topiary-queries` will need to be updated in
   the root and their respective `Cargo.toml` files.

   The version of these subpackages should bump their respective patch
   version (e.g., `0.6.1` would become `0.6.2`), but not the workspace
   version. As these are no longer tied to the Topiary version, they
   will gradually diverge.

2. Do not tag the release, as this will trigger `dist` into cutting a
   full release. However, importantly, the new version of the respective
   subpackage(s) will need to be pushed to `crates.io`:

   ```bash
   # Delete as appropriate
   cargo publish --package topiary-queries
   cargo publish --package topiary-config
   ```

   As with a full release, publication to `crates.io` requires
   appropriate access.

## Generating the PR list for the `CHANGELOG`

If the unreleased changes in the [`CHANGELOG`] have become stale, the
list of merged PRs can be fetched from:

    https://github.com/topiary/topiary/pulls?q=is:pr+base:main+merged:>YYYY-MM-DD

Replacing `YYYY-MM-DD` by the date of the last release.

If you have the GitHub CLI client, something like the following may be
more convenient:

```bash
gh pr list \
    --limit 500 \
    --base main \
    --state merged \
    --json number,mergedAt,title,body \
| jq \
    --raw-output \
    --argjson release "$(gh release view --json createdAt)" \
    '
        reverse
        | .[]
        | select(.mergedAt > $release.createdAt)
        | ["# PR#\(.number): \(.title)", "*Merged: \(.mergedAt)*", "\(.body)\n"]
        | join("\n\n")
    '
```

> [!TIP]
> The `--limit 500` is an arbitrary "large number" :tm: limit of PRs to
> fetch, overriding the low default. As of writing, there's no way to
> set this to "unlimited"; adjust as necessary.

<!-- Links -->
[`CHANGELOG`]: /CHANGELOG.md
[`dist`]: https://opensource.axo.dev/cargo-dist/
[changelog-refresh]: #generating-the-pr-list-for-the-changelog
[release]: https://github.com/topiary/topiary/releases
